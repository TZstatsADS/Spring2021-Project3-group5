---
title: "Random Forest Model File"
author: "Jingbin Cao, jc5514"
date: "3/13/2021"
output: pdf_document
---
# Getting all packages
```{r message=FALSE, warning=FALSE}
if(!require("EBImage")){
 install.packages("BiocManager")
 BiocManager::install("EBImage")
}
if(!require("R.matlab")){
  install.packages("R.matlab")
}
if(!require("readxl")){
  install.packages("readxl")
}

if(!require("dplyr")){
  install.packages("dplyr")
}
if(!require("readxl")){
  install.packages("readxl")
}

if(!require("ggplot2")){
  install.packages("ggplot2")
}

if(!require("caret")){
  install.packages("caret")
}

if(!require("glmnet")){
  install.packages("glmnet")
}

if(!require("WeightedROC")){
  install.packages("WeightedROC")
}

if(!require("gbm")){
  install.packages("gbm")
}

if(!require("DMwR")){
  install.packages("DMwR")
}
if(!require("R.matlab")){
  install.packages("R.matlab")
}
if(!require("randomForest")){
 install.packages("randomForest")
}
if(!require("xgboost")){
 install.packages("xgboost")
}
if(!require("tibble")){
 install.packages("tibble")
}
if(!require("ROSE")){
 install.packages("ROSE")
}
if(!require("ggplot2")){
 install.packages("ggplot2")
}
if(!require("tidyverse")){
 install.packages("tidyverse")
}

if(!require("AUC")){
 install.packages("AUC")
}
if(!require("e1071")){
 install.packages("e1071")
}
if(!require("OpenImageR")){
 install.packages("OpenImageR")
}
if(!require("caTools")){
  install.packages("caTools")
}

library(R.matlab)
library(readxl)
library(dplyr)
library(EBImage)
library(ggplot2)
library(caret)
library(glmnet)
library(WeightedROC)
library(gbm)
library(DMwR)
library(OpenImageR)
library(AUC)
library(e1071)
library(randomForest)
library(xgboost)
library(tibble)
library(ROSE)
library(ggplot2)
library(tidyverse)
library(AUC)
library(e1071)
library(caTools)
library(R.matlab)
```

# All controls you need to adjust
```{r}
run.cv <- FALSE # run cross-validation on the training set
sample.reweight <- FALSE # run sample reweighting in model training
K <- 5  # number of CV folds
gbm.numtrees <- 1000 #number of trees to use in gbm
run.feature.train <- TRUE # process features for training set
run.test <- TRUE # run evaluation on an independent test set
run.feature.test <- TRUE # process features for test set
run.poly.feature <- TRUE # process poly features
run.add.poly.feature <- TRUE # and poly features to dist matrix
run.gbm <- F
needs.balanced <- TRUE # balance data for model fitting
model.selection <- TRUE # perform model selection on svm models
run.balanced.data <- FALSE # Whether or not balance the data
# Random Forest Model Tune and Train
train.random.forest <- FALSE # Train Random Forest Model
test.random.forest <- TRUE # Test Random Forest Model
tune.random.forest <- FALSE # Tune Random Forest Model
test.tune.rf.models <- TRUE # Test the tuning result of Random Forest Models
```

# Setting Data
## Getting raw data ready
```{r}
set.seed(2020)
setwd("../doc")
# All directories for training images:
train_dir <- "../data/train_set/" # This will be modified for different data sets.
train_image_dir <- paste(train_dir, "images/", sep="")
train_pt_dir <- paste(train_dir,  "points/", sep="")
train_label_path <- paste(train_dir, "label.csv", sep="")

# Not sure if you need the code below (from starter code)
lmbd = c(1e-3, 5e-3, 1e-2, 5e-2, 1e-1)
model_labels = paste("LASSO Penalty with lambda =", lmbd)
```
## Import raw data
```{r}
#train-test split
info <- read.csv(train_label_path)
n <- nrow(info) #get number of rows from csv
n_train <- round(n*(4/5), 0) #use 4/5 amount of data for training
train_idx <- sample(info$Index, n_train, replace = F) #grab indexs used for training
test_idx <- setdiff(info$Index, train_idx) # get indexs not used for training

# Below are from starter code
n_files <- length(list.files(train_image_dir,'*jpg'))
image_list <- list()
for(i in 1:100){
   image_list[[i]] <- readImage(paste0(train_image_dir, sprintf("%04d", i), ".jpg"))
}
```
## Read Fiducial Points
```{r}
readMat.matrix <- function(index){
     return(round(readMat(paste0(train_pt_dir, sprintf("%04d", index),".mat"))[[1]],0))
}

#load fiducial points
fiducial_pt_list <- lapply(1:n_files, readMat.matrix)
save(fiducial_pt_list, file="../output/fiducial_pt_list.RData")
```
## Getting all features ready
```{r}
source("../lib/feature.R")
tm_feature_train <- NA
if(run.feature.train){
  tm_feature_train <- system.time(dat_train<-feature(fiducial_pt_list,train_idx, run.poly.feature, run.add.poly.feature))
  save(dat_train, file="../output/feature_train_RF.RData")
}else{
  load(file="../output/feature_train_RF.RData")
}
tm_feature_test <- NA
if(run.feature.test){
  tm_feature_test <- system.time(dat_test <- feature(fiducial_pt_list, test_idx, run.poly.feature, run.add.poly.feature))
  save(dat_test, file="../output/feature_test_RF.RData")
}else{
  load(file="../output/feature_test_RF.RData")
}
# transfer label column from factor to numeric

dat_train$label <- as.numeric(dat_train$label)
dat_test$label <- as.numeric(dat_test$label)
```
## Balanced the data
```{r}
if(run.balanced.data){
dat_train_balanced_rose<-ROSE(label~., dat_train,seed=2020)$data
save(dat_train_balanced_rose, file="../output/balanced_train_data_rose.RData")
dat_test_balanced_rose <- ROSE(label~., dat_test, seed=2020)$data
save(dat_test_balanced_rose, file = "../output/balanced_test_data_rose.RData")
}else{
  load(file = "../output/balanced_train_data_rose.RData")
  load(file = "../output/balanced_test_data_rose.RData")
}
table(dat_train_balanced_rose$label)
table(dat_test_balanced_rose$label)
```
## NOTE! The variables that We already had
```{r}
fiducial_pt_list <- fiducial_pt_list
dat_train <- dat_train #All the CLEAN training data, imbalanced
dat_test <- dat_test # All the CLEAN test data, imbalanced
dat_train_balanced_rose <- dat_train_balanced_rose # All the BALANCED train data (Using ROSE)
dat_test_balanced_rose <- dat_test_balanced_rose # All the BALANCED test data (Using ROSE)
```



# Tuning the Model
## Tune mtry
```{r}
source("../lib/random_forest.R")
if(tune.random.forest){
  time.rf.tune <- system.time(rf.tune <- random_forest_tune(dat_train_balanced_rose))
  save(rf.tune, file="../output/rf_tune.RData")
  save(time.rf.tune, file = "../output/rf_tune_time.RData")
}else{
  load("../output/rf_tune.RData")
  load("../output/rf_tune_time.RData")
}
rf.tune
time.rf.tune[1]
plot(rf.tune, main = "Choose best mtry",type = 'l')
```
mtry = 308 is the best.

## Tune Trees and nodes
```{r}
source("../lib/random_forest.R")
if(tune.random.forest){
  # Train 500 trees:
  time.rf.train.tree500 <- system.time(random_forest_fit_500_trees <- random_forest_train_500(dat_train_balanced_rose,mtry = 308))
  save(random_forest_fit_500_trees, file = "../output/rf_train_500_trees.RData")
  save(time.rf.train.tree500, file = "../output/rf_train_500_trees_time.RData")
  cat("500 tree time", time.rf.train.tree500[1])
  # Train 1000 trees:
  time.rf.train.tree1000 <- system.time(random_forest_fit_1000_trees <- random_forest_train_1000(dat_train_balanced_rose,mtry = 308))
  save(random_forest_fit_1000_trees, file = "../output/rf_train_1000_trees.RData")
  save(time.rf.train.tree1000, file = "../output/rf_train_1000_trees_time.RData")
  cat("1000 tree time", time.rf.train.tree1000[1])
  # Train 1500 trees:
  time.rf.train.tree1500 <- system.time(random_forest_fit_1500_trees <- random_forest_train_1500(dat_train_balanced_rose,mtry = 308))
  save(random_forest_fit_1500_trees, file = "../output/rf_train_1500_trees.RData")
  save(time.rf.train.tree1500, file = "../output/rf_train_1500_trees_time.RData")
  cat("1500 tree time", time.rf.train.tree1500[1])
  # Train 2000 trees:
  time.rf.train.tree2000 <- system.time(random_forest_fit_2000_trees <- random_forest_train_2000(dat_train_balanced_rose,mtry = 308))
  save(random_forest_fit_2000_trees, file = "../output/rf_train_2000_trees.RData")
  save(time.rf.train.tree2000, file = "../output/rf_train_2000_trees_time.RData")
  cat("2000 tree time", time.rf.train.tree2000[1])
  # Train 2500 trees:
  time.rf.train.tree2500 <- system.time(random_forest_fit_2500_trees <- random_forest_train_2500(dat_train_balanced_rose,mtry = 308))
  save(random_forest_fit_2500_trees, file = "../output/rf_train_2500_trees.RData")
  save(time.rf.train.tree2500, file = "../output/rf_train_2500_trees_time.RData")
  cat("2500 tree time", time.rf.train.tree2500[1])

  # Train 10 nodes
  time.rf.train.node10 <- system.time(random_forest_fit_10_nodes <- random_forest_train_10(dat_train_balanced_rose,mtry = 308))
  save(random_forest_fit_10_nodes, file = "../output/rf_train_10_nodes.RData")
  save(time.rf.train.node10, file = "../output/rf_train_10_nodes_time.RData")
  cat("10 node time", time.rf.train.node10[1])
  # Train 15 nodes
  time.rf.train.node15 <- system.time(random_forest_fit_15_nodes <- random_forest_train_15(dat_train_balanced_rose,mtry = 308))
  save(random_forest_fit_15_nodes, file = "../output/rf_train_15_nodes.RData")
  save(time.rf.train.node15, file = "../output/rf_train_15_nodes_time.RData")
  cat("15 node time", time.rf.train.node15[1])
  # Train 20 nodes
  time.rf.train.node20 <- system.time(random_forest_fit_20_nodes <- random_forest_train_20(dat_train_balanced_rose,mtry = 308))
  save(random_forest_fit_20_nodes, file = "../output/rf_train_20_nodes.RData")
  save(time.rf.train.node20, file = "../output/rf_train_20_nodes_time.RData")
  cat("20 node time", time.rf.train.node20[1])
  # Train 25 nodes
  time.rf.train.node25 <- system.time(random_forest_fit_25_nodes <- random_forest_train_25(dat_train_balanced_rose,mtry = 308))
  save(random_forest_fit_25_nodes, file = "../output/rf_train_25_nodes.RData")
  save(time.rf.train.node25, file = "../output/rf_train_25_nodes_time.RData")
  cat("25 node time", time.rf.train.node25[1])
  # Train 30 nodes
  time.rf.train.node30 <- system.time(random_forest_fit_30_nodes <- random_forest_train_30(dat_train_balanced_rose,mtry = 308))
  save(random_forest_fit_30_nodes, file = "../output/rf_train_30_nodes.RData")
  save(time.rf.train.node30, file = "../output/rf_train_30_nodes_time.RData")
  cat("30 node time", time.rf.train.node30[1])
}else{
  load("../output/rf_train_500_trees.RData")
  load("../output/rf_train_1000_trees.RData")
  load("../output/rf_train_1500_trees.RData")
  load("../output/rf_train_2000_trees.RData")
  load("../output/rf_train_2500_trees.RData")
  load("../output/rf_train_10_nodes.RData")
  load("../output/rf_train_15_nodes.RData")
  load("../output/rf_train_20_nodes.RData")
  load("../output/rf_train_25_nodes.RData")
  load("../output/rf_train_30_nodes.RData")
}


if(test.tune.rf.models){
# Evaluate each hyperparameter

# Predicted value from 500 trees' model:
rf_predicted_balanced <- as.numeric(as.vector(random_forest_test(random_forest_fit_500_trees, dat_test_balanced_rose)))
#rf_predicted_imbalanced <- as.numeric(as.vector(random_forest_test(random_forest_fit_500_trees, dat_test)))
# Evaluate 500 trees:
rf_accuracy_balanced <- mean(round(rf_predicted_balanced == dat_test_balanced_rose$label))
tpr.fpr.balanced <- WeightedROC(as.numeric(rf_predicted_balanced),dat_test_balanced_rose$label)
rf_AUC_balanced <- WeightedAUC(tpr.fpr.balanced)
#rf_accuracy_imbalanced <- mean(round(rf_predicted_imbalanced == dat_test$label))
#tpr.fpr.imbalanced <- WeightedROC(as.numeric(rf_predicted_imbalanced),dat_test$label)
#rf_AUC_imbalanced <- WeightedAUC(tpr.fpr.imbalanced)

cat("Accuracy(balanced) 500", rf_accuracy_balanced*100,"%.\n")
cat("AUC(balanced) 500", rf_AUC_balanced,".\n")
#cat("Accuracy(imbalanced) 500", rf_accuracy_imbalanced*100,"%.\n")
#cat("AUC(imbalanced) 500",rf_AUC_imbalanced,".\n")


# Evaluation from 1000 trees' model:
rf_predicted_balanced <- as.numeric(as.vector(random_forest_test(random_forest_fit_1000_trees, dat_test_balanced_rose)))
#f_predicted_imbalanced <- as.numeric(as.vector(random_forest_test(random_forest_fit_1000_trees, dat_test)))

rf_accuracy_balanced <- mean(round(rf_predicted_balanced == dat_test_balanced_rose$label))
tpr.fpr.balanced <- WeightedROC(as.numeric(rf_predicted_balanced),dat_test_balanced_rose$label)
rf_AUC_balanced <- WeightedAUC(tpr.fpr.balanced)
# rf_accuracy_imbalanced <- mean(round(rf_predicted_imbalanced == dat_test_balanced_rose$label))
# tpr.fpr.imbalanced <- WeightedROC(as.numeric(rf_predicted_imbalanced),dat_test$label)
# rf_AUC_imbalanced <- WeightedAUC(tpr.fpr.imbalanced)

cat("Accuracy(balanced) 1000", rf_accuracy_balanced*100,"%.\n")
cat("AUC(balanced) 1000", rf_AUC_balanced,".\n")
# cat("Accuracy(imbalanced) 1000", rf_accuracy_imbalanced*100,"%.\n")
# cat("AUC(imbalanced) 1000",rf_AUC_imbalanced,".\n")

# 1500 trees
rf_predicted_balanced <- as.numeric(as.vector(random_forest_test(random_forest_fit_1500_trees, dat_test_balanced_rose)))
# rf_predicted_imbalanced <- as.numeric(as.vector(random_forest_test(random_forest_fit_1500_trees, dat_test)))

rf_accuracy_balanced <- mean(round(rf_predicted_balanced == dat_test_balanced_rose$label))
tpr.fpr.balanced <- WeightedROC(as.numeric(rf_predicted_balanced),dat_test_balanced_rose$label)
rf_AUC_balanced <- WeightedAUC(tpr.fpr.balanced)
# rf_accuracy_imbalanced <- mean(round(rf_predicted_imbalanced == dat_test_balanced_rose$label))
# tpr.fpr.imbalanced <- WeightedROC(as.numeric(rf_predicted_imbalanced),dat_test$label)
# rf_AUC_imbalanced <- WeightedAUC(tpr.fpr.imbalanced)

cat("Accuracy(balanced) 1500", rf_accuracy_balanced*100,"%.\n")
cat("AUC(balanced) 1500", rf_AUC_balanced,".\n")
# cat("Accuracy(imbalanced) 1500", rf_accuracy_imbalanced*100,"%.\n")
# cat("AUC(imbalanced) 1500",rf_AUC_imbalanced,".\n")

#2000 trees
#rf_predicted_balanced <- as.numeric(as.vector(random_forest_test(random_forest_fit_2000_trees, dat_test_balanced_rose)))
#rf_predicted_imbalanced <- as.numeric(as.vector(random_forest_test(random_forest_fit_2000_trees, dat_test)))

rf_accuracy_balanced <- mean(round(rf_predicted_balanced == dat_test_balanced_rose$label))
tpr.fpr.balanced <- WeightedROC(as.numeric(rf_predicted_balanced),dat_test_balanced_rose$label)
rf_AUC_balanced <- WeightedAUC(tpr.fpr.balanced)
# rf_accuracy_imbalanced <- mean(round(rf_predicted_imbalanced == dat_test_balanced_rose$label))
# tpr.fpr.imbalanced <- WeightedROC(as.numeric(rf_predicted_imbalanced),dat_test$label)
# rf_AUC_imbalanced <- WeightedAUC(tpr.fpr.imbalanced)

cat("Accuracy(balanced) 2000", rf_accuracy_balanced*100,"%.\n")
cat("AUC(balanced) 2000", rf_AUC_balanced,".\n")
# cat("Accuracy(imbalanced) 2000", rf_accuracy_imbalanced*100,"%.\n")
# cat("AUC(imbalanced) 2000",rf_AUC_imbalanced,".\n")

# 2500 trees
rf_predicted_balanced <- as.numeric(as.vector(random_forest_test(random_forest_fit_2500_trees, dat_test_balanced_rose)))
# rf_predicted_imbalanced <- as.numeric(as.vector(random_forest_test(random_forest_fit_2500_trees, dat_test)))

rf_accuracy_balanced <- mean(round(rf_predicted_balanced == dat_test_balanced_rose$label))
tpr.fpr.balanced <- WeightedROC(as.numeric(rf_predicted_balanced),dat_test_balanced_rose$label)
rf_AUC_balanced <- WeightedAUC(tpr.fpr.balanced)
# rf_accuracy_imbalanced <- mean(round(rf_predicted_imbalanced == dat_test_balanced_rose$label))
# tpr.fpr.imbalanced <- WeightedROC(as.numeric(rf_predicted_imbalanced),dat_test$label)
# rf_AUC_imbalanced <- WeightedAUC(tpr.fpr.imbalanced)

cat("Accuracy(balanced) 2500", rf_accuracy_balanced*100,"%.\n")
cat("AUC(balanced) 2500", rf_AUC_balanced,".\n")
# cat("Accuracy(imbalanced) 2500", rf_accuracy_imbalanced*100,"%.\n")
# cat("AUC(imbalanced) 2500",rf_AUC_imbalanced,".\n")

# 10 nodes
rf_predicted_balanced <- as.numeric(as.vector(random_forest_test(random_forest_fit_10_nodes, dat_test_balanced_rose)))
# rf_predicted_imbalanced <- as.numeric(as.vector(random_forest_test(random_forest_fit_10_nodes, dat_test)))

rf_accuracy_balanced <- mean(round(rf_predicted_balanced == dat_test_balanced_rose$label))
tpr.fpr.balanced <- WeightedROC(as.numeric(rf_predicted_balanced),dat_test_balanced_rose$label)
rf_AUC_balanced <- WeightedAUC(tpr.fpr.balanced)
# rf_accuracy_imbalanced <- mean(round(rf_predicted_imbalanced == dat_test_balanced_rose$label))
# tpr.fpr.imbalanced <- WeightedROC(as.numeric(rf_predicted_imbalanced),dat_test$label)
# rf_AUC_imbalanced <- WeightedAUC(tpr.fpr.imbalanced)

cat("Accuracy(balanced) 10", rf_accuracy_balanced*100,"%.\n")
cat("AUC(balanced) 10", rf_AUC_balanced,".\n")
# cat("Accuracy(imbalanced) 10", rf_accuracy_imbalanced*100,"%.\n")
# cat("AUC(imbalanced) 10",rf_AUC_imbalanced,".\n")

# 15 nodes
rf_predicted_balanced <- as.numeric(as.vector(random_forest_test(random_forest_fit_15_nodes, dat_test_balanced_rose)))
# rf_predicted_imbalanced <- as.numeric(as.vector(random_forest_test(random_forest_fit_15_nodes, dat_test)))

rf_accuracy_balanced <- mean(round(rf_predicted_balanced == dat_test_balanced_rose$label))
tpr.fpr.balanced <- WeightedROC(as.numeric(rf_predicted_balanced),dat_test_balanced_rose$label)
rf_AUC_balanced <- WeightedAUC(tpr.fpr.balanced)
# rf_accuracy_imbalanced <- mean(round(rf_predicted_imbalanced == dat_test_balanced_rose$label))
# tpr.fpr.imbalanced <- WeightedROC(as.numeric(rf_predicted_imbalanced),dat_test$label)
# rf_AUC_imbalanced <- WeightedAUC(tpr.fpr.imbalanced)

cat("Accuracy(balanced) 15", rf_accuracy_balanced*100,"%.\n")
cat("AUC(balanced) 15", rf_AUC_balanced,".\n")
# cat("Accuracy(imbalanced) 15", rf_accuracy_imbalanced*100,"%.\n")
# cat("AUC(imbalanced) 15",rf_AUC_imbalanced,".\n")

# 20 nodes
rf_predicted_balanced <- as.numeric(as.vector(random_forest_test(random_forest_fit_20_nodes, dat_test_balanced_rose)))
# rf_predicted_imbalanced <- as.numeric(as.vector(random_forest_test(random_forest_fit_20_nodes, dat_test)))

rf_accuracy_balanced <- mean(round(rf_predicted_balanced == dat_test_balanced_rose$label))
tpr.fpr.balanced <- WeightedROC(as.numeric(rf_predicted_balanced),dat_test_balanced_rose$label)
rf_AUC_balanced <- WeightedAUC(tpr.fpr.balanced)
# rf_accuracy_imbalanced <- mean(round(rf_predicted_imbalanced == dat_test_balanced_rose$label))
# tpr.fpr.imbalanced <- WeightedROC(as.numeric(rf_predicted_imbalanced),dat_test$label)
# rf_AUC_imbalanced <- WeightedAUC(tpr.fpr.imbalanced)

cat("Accuracy(balanced) 20", rf_accuracy_balanced*100,"%.\n")
cat("AUC(balanced) 20", rf_AUC_balanced,".\n")
# cat("Accuracy(imbalanced) 20", rf_accuracy_imbalanced*100,"%.\n")
# cat("AUC(imbalanced) 20",rf_AUC_imbalanced,".\n")

# 25 nodes
rf_predicted_balanced <- as.numeric(as.vector(random_forest_test(random_forest_fit_25_nodes, dat_test_balanced_rose)))
# rf_predicted_imbalanced <- as.numeric(as.vector(random_forest_test(random_forest_fit_25_nodes, dat_test)))

rf_accuracy_balanced <- mean(round(rf_predicted_balanced == dat_test_balanced_rose$label))
tpr.fpr.balanced <- WeightedROC(as.numeric(rf_predicted_balanced),dat_test_balanced_rose$label)
rf_AUC_balanced <- WeightedAUC(tpr.fpr.balanced)
# rf_accuracy_imbalanced <- mean(round(rf_predicted_imbalanced == dat_test_balanced_rose$label))
# tpr.fpr.imbalanced <- WeightedROC(as.numeric(rf_predicted_imbalanced),dat_test$label)
# rf_AUC_imbalanced <- WeightedAUC(tpr.fpr.imbalanced)

cat("Accuracy(balanced) 25", rf_accuracy_balanced*100,"%.\n")
cat("AUC(balanced) 25", rf_AUC_balanced,".\n")
# cat("Accuracy(imbalanced) 25", rf_accuracy_imbalanced*100,"%.\n")
# cat("AUC(imbalanced) 25",rf_AUC_imbalanced,".\n")

# 30 nodes
rf_predicted_balanced <- as.numeric(as.vector(random_forest_test(random_forest_fit_30_nodes, dat_test_balanced_rose)))
#rf_predicted_imbalanced <- as.numeric(as.vector(random_forest_test(random_forest_fit_30_nodes, dat_test)))

rf_accuracy_balanced <- mean(round(rf_predicted_balanced == dat_test_balanced_rose$label))
tpr.fpr.balanced <- WeightedROC(as.numeric(rf_predicted_balanced),dat_test_balanced_rose$label)
rf_AUC_balanced <- WeightedAUC(tpr.fpr.balanced)
# rf_accuracy_imbalanced <- mean(round(rf_predicted_imbalanced == dat_test_balanced_rose$label))
# tpr.fpr.imbalanced <- WeightedROC(as.numeric(rf_predicted_imbalanced),dat_test$label)
# rf_AUC_imbalanced <- WeightedAUC(tpr.fpr.imbalanced)

cat("Accuracy(balanced) 30", rf_accuracy_balanced*100,"%.\n")
cat("AUC(balanced) 30", rf_AUC_balanced,".\n")
#cat("Accuracy(imbalanced) 30", rf_accuracy_imbalanced*100,"%.\n")
#cat("AUC(imbalanced) 30",rf_AUC_imbalanced,".\n")
}
```

25 Nodes and 1500 trees is the best.



# Performance of the final greatest model (tuned)
## Training and Evaluating the greatest RF model
```{r}
if(train.random.forest){
  time.rf.train.final.balanced <- system.time(random_forest_fit_final_balanced <- random_forest_train(dat_train_balanced_rose, mtry = 308, tree_number = 1500, node_size = 25))
  save(random_forest_fit_final_balanced, file = "../output/rf_train_final_balanced.RData")
  save(time.rf.train.final.balanced, file = "../output/rf_train_final_time_balanced.RData")
  time.rf.train.final.imbalanced <- system.time(random_forest_fit_final_imbalanced <- random_forest_train(dat_train, mtry = 308, tree_number = 1500, node_size = 25))
  save(time.rf.train.final.imbalanced, file = "../output/rf_train_final_time_imbalanced.RData")
  save(random_forest_fit_final_imbalanced, file = "../output/rf_train_final_imbalanced.RData")
}else{
  load("../output/rf_train_final_balanced.RData")
  load("../output/rf_train_final_time_balanced.RData")
  load("../output/rf_train_final_time_imbalanced.RData")
  load("../output/rf_train_final_imbalanced.RData")
}
# Evaluation:
# Balanced:
if(test.random.forest){
time.rf.test.final.balanced <- system.time(rf_predicted_balanced <- as.numeric(as.vector(random_forest_test(random_forest_fit_final_balanced, dat_test_balanced_rose))))
rf_accuracy_balanced <- mean(round(rf_predicted_balanced == dat_test_balanced_rose$label))
tpr.fpr.balanced <- WeightedROC(as.numeric(rf_predicted_balanced),dat_test_balanced_rose$label)
rf_AUC_balanced <- WeightedAUC(tpr.fpr.balanced)

cat("AUC for tuned Random Forest(balanced): ", rf_AUC_balanced,".\n")
cat("Accuracy for tuned Random Forest(balanced)", rf_accuracy_balanced*100,"%.\n")
cat("Training time for tuned Random Forest: ", time.rf.train.final.balanced[1], "s.\n")
cat("Testing time for tuned Random Forest: ", time.rf.test.final.balanced[1], "s.\n")

# Imbalanced:
time.rf.test.final.imbalanced <- system.time(rf_predicted_imbalanced <- as.numeric(as.vector(random_forest_test(random_forest_fit_final_imbalanced, dat_test))))
rf_accuracy_imbalanced <- mean(round(rf_predicted_imbalanced == dat_test$label))
tpr.fpr.imbalanced <- WeightedROC(as.numeric(rf_predicted_imbalanced),dat_test$label)
rf_AUC_imbalanced <- WeightedAUC(tpr.fpr.imbalanced)

cat("AUC for tuned Random Forest(imbalanced): ", rf_AUC_imbalanced,".\n")
cat("Accuracy for tuned Random Forest(imbalanced)", rf_accuracy_imbalanced*100,"%.\n")
cat("Training time for tuned Random Forest: ", time.rf.train.final.imbalanced[1], "s.\n")
cat("Testing time for tuned Random Forest: ", time.rf.test.final.imbalanced[1], "s.\n")
}
```


